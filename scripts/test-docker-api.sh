#!/bin/bash

echo "ğŸ”§ Testando conectividade Docker Node-RED"
echo ""

WSL_IP=$(ip addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)

echo "ğŸ“ IP do WSL2: $WSL_IP"
echo ""

echo "âœ… Teste 1: localhost"
curl -s http://localhost:1880/api/medications > /dev/null && echo "   âœ… localhost:1880 acessÃ­vel" || echo "   âŒ localhost:1880 FALHOU"

echo ""
echo "âœ… Teste 2: IP do WSL2"
curl -s http://$WSL_IP:1880/api/medications > /dev/null && echo "   âœ… $WSL_IP:1880 acessÃ­vel" || echo "   âŒ $WSL_IP:1880 FALHOU"

echo ""
echo "âœ… Teste 3: Contagem de medicamentos"
COUNT=$(curl -s http://$WSL_IP:1880/api/medications | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null)
echo "   ğŸ“Š $COUNT medicamentos encontrados"

echo ""
echo "ğŸ”¥ Configurando firewall WSL2..."
sudo iptables -I INPUT -p tcp --dport 1880 -j ACCEPT 2>/dev/null || echo "   âš ï¸  NÃ£o foi possÃ­vel configurar iptables (normal no WSL2)"

echo ""
echo "ğŸ“± URL para o .env:"
echo "   EXPO_PUBLIC_API_URL=http://$WSL_IP:1880/api"
echo ""
echo "âœ… Agora reinicie o app Android!"
